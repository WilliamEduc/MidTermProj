package PayrollSystem;

import CodeBase.Checker;
import CodeBase.Payroll;
import CodeBase.SalaryCalculations;

import javax.swing.*;
import java.awt.*;
import java.io.FileWriter;
import java.util.Optional;

/*
 * PayrollSystemGUI provides a graphical user interface for the ABC Payroll System.
 * It allows users to add, remove, list employees, and generate payroll and payslips.
 */
public class PayrollSystemGUI {
    //Employee database instance
    private EmployeeDatabase db = new EmployeeDatabase();
    //Input validation helper
    private Checker checker = new Checker();

    /* The main application window
    * The main panel that holds all screens
    * CardLayout for switching between screens
    * */
    private JFrame mainFrame;
    private JPanel mainPanel;
    private CardLayout cardLayout;

    // Panel for the main menu
    private JPanel menuPanel;
    private JPanel addEmployeePanel;
    private JPanel removeEmployeePanel;
    private JPanel listEmployeesPanel;
    private JPanel generatePayrollPanel;


    //Constructs the PayrollSystemGUI and initializes the GUI.
    public PayrollSystemGUI() {
        initializeGUI();
    }

      //Sets up the main frame and all panels for the application.
    private void initializeGUI() {
        mainFrame = new JFrame("ABC Payroll System");
        mainFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        mainFrame.setSize(500, 350);
        mainFrame.setLocationRelativeTo(null);

        cardLayout = new CardLayout();
        mainPanel = new JPanel(cardLayout);

        createMenuPanel();
        createAddEmployeePanel();
        createRemoveEmployeePanel();
        createListEmployeesPanel();
        createGeneratePayrollPanel();

        mainPanel.add(menuPanel, "Menu");
        mainPanel.add(addEmployeePanel, "AddEmployee");
        mainPanel.add(removeEmployeePanel, "RemoveEmployee");
        mainPanel.add(listEmployeesPanel, "ListEmployees");
        mainPanel.add(generatePayrollPanel, "GeneratePayroll");

        mainFrame.add(mainPanel);
        mainFrame.setVisible(true);
    }

    //Creates the main menu panel with navigation buttons.
    private void createMenuPanel() {
        menuPanel = new JPanel(new GridLayout(5, 1, 10, 10));
        menuPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        JButton addEmployeeBtn = new JButton("Add Employee");
        addEmployeeBtn.setBackground(new Color(33, 150, 243));
        addEmployeeBtn.setForeground(Color.WHITE);
        addEmployeeBtn.setOpaque(true);
        addEmployeeBtn.setBorderPainted(false);
        JButton removeEmployeeBtn = new JButton("Remove Employee");
        removeEmployeeBtn.setBackground(new Color(33, 150, 243));
        removeEmployeeBtn.setForeground(Color.WHITE);
        removeEmployeeBtn.setOpaque(true);
        removeEmployeeBtn.setBorderPainted(false);
        JButton listEmployeesBtn = new JButton("List Employees");
        listEmployeesBtn.setBackground(new Color(33, 150, 243));
        listEmployeesBtn.setForeground(Color.WHITE);
        listEmployeesBtn.setOpaque(true);
        listEmployeesBtn.setBorderPainted(false);
        JButton generatePayrollBtn = new JButton("Generate Payroll");
        generatePayrollBtn.setBackground(new Color(33, 150, 243));
        generatePayrollBtn.setForeground(Color.WHITE);
        generatePayrollBtn.setOpaque(true);
        generatePayrollBtn.setBorderPainted(false);
        JButton exitBtn = new JButton("Exit");
        exitBtn.setBackground(new Color(33, 150, 243));
        exitBtn.setForeground(Color.WHITE);
        exitBtn.setOpaque(true);
        exitBtn.setBorderPainted(false);

        addEmployeeBtn.addActionListener(e -> cardLayout.show(mainPanel, "AddEmployee"));
        removeEmployeeBtn.addActionListener(e -> {
            refreshEmployeeList();
            cardLayout.show(mainPanel, "RemoveEmployee");
        });
        listEmployeesBtn.addActionListener(e -> {
            displayEmployees();
            cardLayout.show(mainPanel, "ListEmployees");
        });
        generatePayrollBtn.addActionListener(e -> {
            refreshEmployeeListForPayroll();
            cardLayout.show(mainPanel, "GeneratePayroll");
        });
        exitBtn.addActionListener(e -> System.exit(0));

        menuPanel.add(addEmployeeBtn);
        menuPanel.add(removeEmployeeBtn);
        menuPanel.add(listEmployeesBtn);
        menuPanel.add(generatePayrollBtn);
        menuPanel.add(exitBtn);
    }

      //Creates the panel for adding a new employee.
    private void createAddEmployeePanel() {
        addEmployeePanel = new JPanel(new BorderLayout(10, 10));
        addEmployeePanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        JPanel formPanel = new JPanel(new GridLayout(5, 2, 10, 10));
        JTextField idField = new JTextField();
        JTextField nameField = new JTextField();
        JTextField deptField = new JTextField();
        JTextField salaryField = new JTextField();
        JTextField hoursField = new JTextField();

        formPanel.add(new JLabel("Employee ID (EMP-XXXX):"));
        formPanel.add(idField);
        formPanel.add(new JLabel("Employee Name:"));
        formPanel.add(nameField);
        formPanel.add(new JLabel("Department:"));
        formPanel.add(deptField);
        formPanel.add(new JLabel("Basic Salary:"));
        formPanel.add(salaryField);
        formPanel.add(new JLabel("Overtime Hours:"));
        formPanel.add(hoursField);

        JPanel buttonPanel = new JPanel(new FlowLayout());
        JButton submitBtn = new JButton("Submit");
        submitBtn.setBackground(new Color(33, 150, 243));
        submitBtn.setForeground(Color.WHITE);
        submitBtn.setOpaque(true);
        submitBtn.setBorderPainted(false);
        JButton backBtn = new JButton("Back to Menu");
        backBtn.setBackground(new Color(33, 150, 243));
        backBtn.setForeground(Color.WHITE);
        backBtn.setOpaque(true);
        backBtn.setBorderPainted(false);

        submitBtn.addActionListener(e -> {
            String id = idField.getText().trim();
            String name = nameField.getText().trim();
            String dept = deptField.getText().trim();
            String salaryText = salaryField.getText().trim();
            String hoursText = hoursField.getText().trim();

            if (!checker.isValidEmployeeId(id)) {
                showError(checker.getEmployeeIdErrorMessage(id));
                return;
            }
            if (!checker.isValidEmployeeName(name)) {
                showError(checker.getEmployeeNameErrorMessage(name));
                return;
            }
            if (dept.isEmpty()) {
                showError("Department cannot be empty");
                return;
            }

            try {
                double salary = Double.parseDouble(salaryText);
                int hours = Integer.parseInt(hoursText);

                if (!checker.isValidBasicSalary(salary)) {
                    showError(checker.getBasicSalaryErrorMessage(salary));
                    return;
                }

                if (!checker.isValidOvertimeHours(hours)) {
                    showError(checker.getOvertimeHoursErrorMessage(hours));
                    return;
                }

                Payroll emp = new Payroll();
                emp.setEmployeeId(id);
                emp.setEmployeeName(name);
                emp.setDepartment(dept);
                emp.setBasicSalary(salary);
                emp.setOvertimeHours(hours);
                db.addEmployee(emp);

                showSuccess("Employee added successfully!");
                idField.setText(""); nameField.setText("");
                deptField.setText(""); salaryField.setText(""); hoursField.setText("");
            } catch (NumberFormatException ex) {
                showError("Enter valid numbers for salary and hours.");
            }
        });

        backBtn.addActionListener(e -> cardLayout.show(mainPanel, "Menu"));
        buttonPanel.add(submitBtn);
        buttonPanel.add(backBtn);

        addEmployeePanel.add(formPanel, BorderLayout.CENTER);
        addEmployeePanel.add(buttonPanel, BorderLayout.SOUTH);
    }

    //Creates the panel for removing an employee.
    private void createRemoveEmployeePanel() {
        removeEmployeePanel = new JPanel(new BorderLayout());
        JComboBox<String> idComboBox = new JComboBox<>();
        removeEmployeePanel.add(new JLabel("Select Employee ID:"), BorderLayout.NORTH);
        removeEmployeePanel.add(idComboBox, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel();
        JButton removeBtn = new JButton("Remove");
        removeBtn.setBackground(new Color(33, 150, 243));
        removeBtn.setForeground(Color.WHITE);
        removeBtn.setOpaque(true);
        removeBtn.setBorderPainted(false);
        JButton backBtn = new JButton("Back to Menu");
        backBtn.setBackground(new Color(33, 150, 243));
        backBtn.setForeground(Color.WHITE);
        backBtn.setOpaque(true);
        backBtn.setBorderPainted(false);

        removeBtn.addActionListener(e -> {
            String id = (String) idComboBox.getSelectedItem();
            if (id != null && db.removeEmployeeById(id)) {
                showSuccess("Employee removed successfully!");
                refreshEmployeeList();
            } else {
                showError("Employee not found.");
            }
        });

        backBtn.addActionListener(e -> cardLayout.show(mainPanel, "Menu"));
        buttonPanel.add(removeBtn);
        buttonPanel.add(backBtn);
        removeEmployeePanel.add(buttonPanel, BorderLayout.SOUTH);
    }

      //Creates the panel for listing all employees.
    private void createListEmployeesPanel() {
        listEmployeesPanel = new JPanel(new BorderLayout());
        JTextArea employeeListArea = new JTextArea();
        employeeListArea.setEditable(false);
        JScrollPane scrollPane = new JScrollPane(employeeListArea);
        JButton backBtn = new JButton("Back to Menu");
        backBtn.setBackground(new Color(33, 150, 243));
        backBtn.setForeground(Color.WHITE);
        backBtn.setOpaque(true);
        backBtn.setBorderPainted(false);

        backBtn.addActionListener(e -> cardLayout.show(mainPanel, "Menu"));
        listEmployeesPanel.add(scrollPane, BorderLayout.CENTER);
        listEmployeesPanel.add(backBtn, BorderLayout.SOUTH);
    }

    //Creates the panel for generating payroll and payslips.
    private void createGeneratePayrollPanel() {
        generatePayrollPanel = new JPanel(new BorderLayout());
        JComboBox<String> idComboBox = new JComboBox<>();
        JTextArea payslipArea = new JTextArea();
        payslipArea.setEditable(false);
        JScrollPane scrollPane = new JScrollPane(payslipArea);

        JPanel formPanel = new JPanel();
        formPanel.add(new JLabel("Select Employee ID:"));
        formPanel.add(idComboBox);

        JButton generateBtn = new JButton("Generate Payslip");
        generateBtn.setBackground(new Color(33, 150, 243));
        generateBtn.setForeground(Color.WHITE);
        generateBtn.setOpaque(true);
        generateBtn.setBorderPainted(false);
        JButton backBtn = new JButton("Back to Menu");
        backBtn.setBackground(new Color(33, 150, 243));
        backBtn.setForeground(Color.WHITE);
        backBtn.setOpaque(true);
        backBtn.setBorderPainted(false);

        generateBtn.addActionListener(e -> {
            String id = (String) idComboBox.getSelectedItem();
            Optional<Payroll> opt = db.getAllEmployees().stream()
                    .filter(emp -> emp.getEmployeeId().equals(id)).findFirst();

            if (opt.isPresent()) {
                Payroll emp = opt.get();
                new SalaryCalculations(emp).calculateAndStorePayroll();
                String payslip = generatePayslipText(emp);
                payslipArea.setText(payslip);
                payslipArea.setCaretPosition(0);

                try (FileWriter writer = new FileWriter(emp.getEmployeeName().replaceAll("[^a-zA-Z0-9]", "_") + "_payslip.txt")) {
                    writer.write(payslip);
                    showSuccess("Payslip file saved.");
                } catch (Exception ex) {
                    showError("Error saving file.");
                }
            } else {
                showError("Employee not found.");
            }
        });

        backBtn.addActionListener(e -> cardLayout.show(mainPanel, "Menu"));

        JPanel btnPanel = new JPanel();
        btnPanel.add(generateBtn);
        btnPanel.add(backBtn);

        generatePayrollPanel.add(formPanel, BorderLayout.NORTH);
        generatePayrollPanel.add(scrollPane, BorderLayout.CENTER);
        generatePayrollPanel.add(btnPanel, BorderLayout.SOUTH);
    }

    /*
     * Generates the payslip text for an employee.
     * The Payroll object representing the employee.
     * return The formatted payslip as a String
     */
    private String generatePayslipText(Payroll emp) {
        return String.format(
                "ABC Solutions - Employee Payslip (2025)\n" +
                        "=================================\n" +
                        "Employee ID: %s\nName: %s\nDepartment: %s\n\n" +
                        "EARNINGS\n" +
                        "Basic Salary: ₱ %.2f\nOvertime Pay: ₱ %.2f\nGross Pay: ₱ %.2f\n\n" +
                        "DEDUCTIONS (2025 rates)\n" +
                        "SSS Contribution: ₱ %.2f\nPhilHealth Contribution: ₱ %.2f\nPag-IBIG Contribution: ₱ %.2f\nIncome Tax: ₱ %.2f\n" +
                        "Total Deductions: ₱ %.2f\n\n" +
                        "=================================\nNET PAY: ₱ %.2f\n=================================\n",
                emp.getEmployeeId(), emp.getEmployeeName(), emp.getDepartment(),
                emp.getBasicSalary(), emp.getOvertimePay(), emp.getGrossPay(),
                emp.getSssContribution(), emp.getPhilHealthContribution(), emp.getPagIbigContribution(),
                emp.getIncomeTax(), emp.getTotalDeductions(), emp.getNetPay()
        );
    }


     //Updates the employee dropdown in the remove employee panel.
    private void refreshEmployeeList() {
        JComboBox<String> combo = (JComboBox<String>) ((BorderLayout) removeEmployeePanel.getLayout()).getLayoutComponent(BorderLayout.CENTER);
        combo.removeAllItems();
        db.getAllEmployees().forEach(emp -> combo.addItem(emp.getEmployeeId()));
    }


     //Updates the employee dropdown in the payroll generation panel.
    private void refreshEmployeeListForPayroll() {
        JComboBox<String> combo = (JComboBox<String>) ((JPanel) generatePayrollPanel.getComponent(0)).getComponent(1);
        combo.removeAllItems();
        db.getAllEmployees().forEach(emp -> combo.addItem(emp.getEmployeeId()));
    }


     //Displays all employees in the list panel.
    private void displayEmployees() {
        JTextArea area = (JTextArea) ((JScrollPane) listEmployeesPanel.getComponent(0)).getViewport().getView();
        area.setText("");

        if (db.getAllEmployees().isEmpty()) {
            area.setText("No employees to display.");
        } else {
            StringBuilder sb = new StringBuilder("Employee List:\n\n");
            db.getAllEmployees().forEach(emp -> sb.append(String.format(
                    "ID: %s, Name: %s, Dept: %s, Salary: %.2f, OT: %.0f\n",
                    emp.getEmployeeId(),
                    emp.getEmployeeName(),
                    emp.getDepartment(),
                    emp.getBasicSalary(),
                    emp.getOvertimeHours()
            )));
            area.setText(sb.toString());
        }
    }

    /*
     * Shows an error dialog with the given message.
     * At String msg, The error message to display
     */
    private void showError(String msg) {
        JOptionPane.showMessageDialog(mainFrame, msg, "Error", JOptionPane.ERROR_MESSAGE);
    }

    /*
     * Shows a success dialog with the given message.
     * And the String msg, The success message will successfully displayed.
     */
    private void showSuccess(String msg) {
        JOptionPane.showMessageDialog(mainFrame, msg, "Success", JOptionPane.INFORMATION_MESSAGE);
    }

    /*
     * Main entry point. Launches the PayrollSystemGUI.
     * @param args Command-line arguments
     */
    public static void main(String[] args) {
        SwingUtilities.invokeLater(PayrollSystemGUI::new);
    }
}
